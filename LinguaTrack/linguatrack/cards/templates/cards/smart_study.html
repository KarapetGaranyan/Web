{% extends 'cards/base.html' %}

{% block title %}–£–º–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ - LinguaTrack{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2>üß† –£–º–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ</h2>
                <div>
                    <span class="badge bg-info">{{ studied_count }}/{{ total_count }}</span>
                    <span class="badge bg-secondary">SM-2 –∞–ª–≥–æ—Ä–∏—Ç–º</span>
                </div>
            </div>
            <div class="progress">
                <div class="progress-bar bg-gradient" role="progressbar" 
                     style="width: {% if total_count > 0 %}{% widthratio studied_count total_count 100 %}{% else %}0{% endif %}%">
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="card study-card mb-4 border-primary">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="badge bg-secondary">{{ card.get_difficulty_display }}</span>
                    <span class="badge bg-info">–ò–∑—É—á–µ–Ω–∞ {{ card.times_studied }} —Ä–∞–∑</span>
                    {% if card.accuracy_rate > 0 %}
                        <span class="badge bg-success">{{ card.accuracy_rate }}% —Ç–æ—á–Ω–æ—Å—Ç—å</span>
                    {% endif %}
                </div>
                
                <h1 class="display-4 mb-4">{{ card.word }}</h1>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ -->
                <div class="mb-3">
                    {% if card.audio %}
                        <button onclick="playAudio({{ card.pk }})" class="btn btn-outline-primary btn-sm">
                            üîä –û–∑–≤—É—á–∏—Ç—å
                        </button>
                        <audio id="audio-{{ card.pk }}" preload="none">
                            <source src="{% url 'cards:play_audio' card.pk %}" type="audio/mpeg">
                        </audio>
                    {% else %}
                        <a href="{% url 'cards:generate_audio' card.pk %}" class="btn btn-outline-secondary btn-sm">
                            üéµ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ
                        </a>
                    {% endif %}
                </div>
                
                {% if card.example and not show_result %}
                    <p class="text-muted">
                        <em>{{ card.example }}</em>
                    </p>
                {% endif %}
                
                {% if show_result %}
                    <!-- –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
                    <div class="alert 
                        {% if quality_score >= 5 %}alert-success
                        {% elif quality_score >= 4 %}alert-info  
                        {% elif quality_score >= 3 %}alert-warning
                        {% else %}alert-danger{% endif %}">
                        
                        <h4>
                            {% if quality_score >= 5 %}üéâ –ò–¥–µ–∞–ª—å–Ω–æ!
                            {% elif quality_score >= 4 %}‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
                            {% elif quality_score >= 3 %}‚ö†Ô∏è –°–ª–æ–∂–Ω–æ, –Ω–æ –∑–∞—Å—á–∏—Ç–∞–Ω–æ
                            {% else %}‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ{% endif %}
                        </h4>
                        
                        <p><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> {{ card.translation }}</p>
                        <p><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> {{ user_answer }}</p>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                –°–ª–µ–¥—É—é—â–µ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ: {{ next_review|date:"d.m.Y H:i" }}
                                (—á–µ—Ä–µ–∑ {{ next_review|timeuntil }})
                            </small>
                        </div>
                    </div>
                    
                    {% if card.example %}
                        <div class="mt-3 p-3 bg-light rounded">
                            <strong>–ü—Ä–∏–º–µ—Ä:</strong>
                            <p class="text-muted mb-0">{{ card.example }}</p>
                        </div>
                    {% endif %}
                    
                    {% if card.note %}
                        <div class="mt-3 p-3 bg-light rounded">
                            <strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong>
                            <p class="text-muted mb-0">{{ card.note }}</p>
                        </div>
                    {% endif %}
                    
                    <div class="mt-4">
                        <a href="{% url 'cards:next_smart_card' %}" class="btn btn-primary btn-lg">
                            –°–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ ‚Üí
                        </a>
                    </div>
                {% else %}
                    <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
                    <form method="post" onsubmit="startTimer()">
                        {% csrf_token %}
                        <div class="mb-3">
                            {{ form.answer }}
                        </div>
                        <button type="submit" class="btn btn-success btn-lg">
                            –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        
        <div class="text-center">
            <a href="{% url 'cards:card_list' %}" class="btn btn-outline-secondary">
                ‚¨ÖÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–∑—É—á–µ–Ω–∏–µ
            </a>
        </div>
    </div>
</div>

<script>
let startTime = Date.now();

function startTimer() {
    startTime = Date.now();
}

function playAudio(cardId) {
    const audio = document.getElementById(`audio-${cardId}`);
    if (audio) {
        audio.play().catch(e => console.log('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
    }
}
</script>
{% endblock %}