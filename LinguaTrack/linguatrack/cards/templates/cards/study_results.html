{% extends 'cards/base.html' %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–∑—É—á–µ–Ω–∏—è - LinguaTrack{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1>üìä –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é -->
        <div class="card mb-4">
            <div class="card-header bg-gradient bg-primary text-white">
                <h5 class="mb-0">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border-end">
                            <h3 class="text-primary">{{ week_stats.total }}</h3>
                            <small>–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h3 class="text-success">{{ week_stats.correct }}</h3>
                            <small>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h3 class="text-info">{{ week_stats.cards_studied }}</h3>
                            <small>–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning">{{ due_cards }}</h3>
                        <small>–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é</small>
                    </div>
                </div>

                {% if week_stats.total > 0 %}
                    <div class="mt-4">
                        <div class="d-flex justify-content-between mb-1">
                            <span>–¢–æ—á–Ω–æ—Å—Ç—å –∑–∞ –Ω–µ–¥–µ–ª—é:</span>
                            <span><strong>{% widthratio week_stats.correct week_stats.total 100 %}%</strong></span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-gradient bg-success"
                                 style="width: {% widthratio week_stats.correct week_stats.total 100 %}%">
                                {% widthratio week_stats.correct week_stats.total 100 %}%
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏ -->
        {% if recent_sessions %}
            <div class="card">
                <div class="card-header">
                    <h5>üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –∏–∑—É—á–µ–Ω–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>–°–ª–æ–≤–æ</th>
                                    <th>–í–∞—à –æ—Ç–≤–µ—Ç</th>
                                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                                    <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
                                    <th>–í—Ä–µ–º—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in recent_sessions %}
                                    <tr>
                                        <td>
                                            <strong>{{ session.card.word }}</strong><br>
                                            <small class="text-muted">{{ session.card.translation }}</small>
                                        </td>
                                        <td>
                                            {% if session.user_answer %}
                                                {{ session.user_answer|truncatechars:30 }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge
                                                {% if session.result == 'perfect' %}bg-success
                                                {% elif session.result == 'correct' %}bg-info
                                                {% elif session.result == 'hard' %}bg-warning
                                                {% else %}bg-danger{% endif %}">
                                                {{ session.get_result_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% for i in "12345" %}
                                                    <span class="
                                                        {% if session.quality_score >= i|add:0 %}text-warning
                                                        {% else %}text-muted{% endif %}">‚òÖ</span>
                                                {% endfor %}
                                            </div>
                                        </td>
                                        <td>
                                            <small>{{ session.created_at|date:"d.m H:i" }}</small>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="col-md-4">
        <!-- Telegram —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        {% if user.telegram_profile %}
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ü§ñ Telegram –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>–°—Ç–∞—Ç—É—Å:</span>
                            <span class="badge bg-success">–ü–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</span>
                            <span class="
                                {% if user.telegram_profile.notifications_enabled %}text-success
                                {% else %}text-danger{% endif %}">
                                {% if user.telegram_profile.notifications_enabled %}‚úÖ{% else %}‚ùå{% endif %}
                            </span>
                        </div>
                    </div>
                    <small class="text-muted">
                        –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:<br>
                        {{ user.telegram_profile.last_interaction|date:"d.m.Y H:i" }}
                    </small>
                </div>
            </div>
        {% endif %}

        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">üéØ –û–±—â–∏–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>–í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫:</span>
                        <span class="fw-bold">{{ stats.total_cards }}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>–í—ã—É—á–µ–Ω–æ:</span>
                        <span class="fw-bold text-success">{{ stats.learned_cards }}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>–û–±—â–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å:</span>
                        <span class="fw-bold">{{ stats.accuracy_rate }}%</span>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>–í—Ä–µ–º—è –∏–∑—É—á–µ–Ω–∏—è:</span>
                        <span class="fw-bold">{{ stats.study_time_minutes }} –º–∏–Ω</span>
                    </div>
                </div>

                <!-- Streak -->
                {% if stats.streak_days > 0 %}
                    <div class="alert alert-success py-2">
                        üî• Streak: {{ stats.streak_days }} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥!
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
        <div class="card">
            <div class="card-header bg-warning">
                <h5 class="mb-0">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
            </div>
            <div class="card-body">
                {% if due_cards > 0 %}
                    <div class="alert alert-info py-2 mb-2">
                        üìö –ü–æ–≤—Ç–æ—Ä–∏ {{ due_cards }} –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–µ–≥–æ–¥–Ω—è
                    </div>
                {% endif %}

                {% if stats.accuracy_rate < 70 %}
                    <div class="alert alert-warning py-2 mb-2">
                        üéØ –£–ª—É—á—à–∏ —Ç–æ—á–Ω–æ—Å—Ç—å - –±–æ–ª—å—à–µ –ø–æ–≤—Ç–æ—Ä—è–π —Å–ª–æ–∂–Ω—ã–µ —Å–ª–æ–≤–∞
                    </div>
                {% endif %}

                {% if stats.current_week_studied < stats.weekly_goal %}
                    <div class="alert alert-primary py-2 mb-2">
                        üèÉ‚Äç‚ôÇÔ∏è –î–æ —Ü–µ–ª–∏ –Ω–µ–¥–µ–ª–∏: {{ cards_left_to_goal }} –∫–∞—Ä—Ç–æ—á–µ–∫
                    </div>
                {% endif %}

                <div class="d-grid gap-2">
                    {% if due_cards > 0 %}
                        <a href="{% url 'cards:smart_study' %}" class="btn btn-primary btn-sm">
                            üß† –£–º–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ
                        </a>
                    {% endif %}
                    <a href="{% url 'cards:card_create' %}" class="btn btn-success btn-sm">
                        ‚ûï –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}